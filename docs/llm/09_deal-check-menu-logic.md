---
# Deal Check Menu Logic (pages/100_개인별_세일즈맵_누락_리스트.py)

## Purpose
- R1~R15 데이터 품질 규칙으로 개인별 세일즈맵 누락/오류 딜을 찾는 로직을 완전하게 전달해, 다른 에이전트가 동일한 메뉴를 재구현·수정할 수 있게 합니다.

## Audience
- Primary: 외부 LLM / 신규 투입된 LLM 에이전트
- Secondary: 데이터 품질 점검을 담당하는 개발자/운영자

## Scope
- In-scope: 입력 데이터(테이블·컬럼), 전처리·정규화, 모든 규칙 정의/예외, 필터/표시 로직, 결과 집계 방식
- Out-of-scope: 다른 페이지 로직, P&L/체결률 계산

## Sources of truth (do not guess)
- ../README.md, ../implementation.md, ../pages.md, ../data-sources.md, ../database.md, ../context-bridge.md, ../TODO.md
- ../../data.py (load_all_deal), ../../pages/100_개인별_세일즈맵_누락_리스트.py

## Update triggers
- R1~R15 정의/예외/대상 팀이나 필터 변경 시
- all deal 스키마가 변해 컬럼 이름/형식 보정이 필요할 때
- 팀/담당자 맵이 바뀌어 필터 옵션이 변할 때

## Open questions / TODO
- 팀/담당자 구성(TEAM_RAW) 변경 시 규칙 대상 범위를 최신화 필요
- 필드 명세(특히 온라인 입과/강사 정보)가 소스 시스템에서 바뀌면 예외/매핑 점검 필요

---

## Data source & filter
- Input: `load_all_deal()`(SQLite `all_deal`, 2025년 중심 all pipeline). 금액 단위는 원(숫자화 후 사용).
- 팀 매핑: `TEAM_RAW` 3개 팀(기업교육 1팀/2팀, 공공사업그룹)만 대상. `NAME2TEAM`으로 담당자→팀 역매핑 후 팀이 없는 행은 제외.
- 기타 필터: 딜 이름에 `비매출입과` 포함 시 전부 제외.
- 기간 필터: 생성 기준 `2024-10-01` 이후만 사용. `생성 날짜`가 없으면 `생성년도/월/일`로 날짜 생성.
- 담당자/기업별 예외 제거: `apply_deal_exclusions()`에서
  - 담당자=김민선 & 이름∈{신세계백화점_직급별 생성형 AI, 우리은행_WLT II DT 평가과정} 제거
  - 담당자=김윤지 & 이름 prefix `현대씨앤알_콘텐츠 임차_` 제거

## Column normalization (standards the rules rely on)
- Key columns ensured via `ensure_column(dst, src_candidates)`:
  - 수주 예정일(=수주 예정일/수주 예정일(종합)), 계약 체결일(=계약 체결일/계약체결일), 수강시작일, 수강종료일 → `pd.to_datetime`
  - 예상 체결액(=예상 체결액/수주 예정액(종합)), 금액(=금액/Net) → 숫자형
  - 카테고리(=카테고리/카테고리(대)), 과정포맷(=과정포맷/과정포맷(대)), 코스 ID → 문자열
  - 팀_0_name이 없으면 `팀` 값을 채움
- 문자열 정규화: 담당자_name 끝의 `B` 제거, 과정포맷/카테고리는 `str.strip()`.
- 상태/성사 표준화:
  - `상태_norm`: won|lost|convert|그외(소문자) (`won/확정`, `lost/lose`, `convert` 매핑)
  - `성사_norm`: 확정/높음/낮음/LOST/미기재 (빈 문자열까지 결측 취급)
- 결측 판단:
  - `missing_str_or_na`: NaN/빈 문자열/"nan"/"null"/"nat" 등까지 결측 처리
  - `missing_num_or_na`: NaN만 결측
- 추가 필드 확보(없으면 NA로 채움): 연락처/직급/교육영역, 온라인 입과 정보, 강사 이름/강사료.

## Rule definitions (R1~R15)
- 공통: 모두 2024-10-01 이후 & 팀 필터 반영된 데이터 대상. 금액 0은 허용(결측만 문제).
- R1: `상태=won` & 계약 체결일 없음.
- R2: `상태=won` & 금액 결측 (0 허용, NaN만 문제).
- R3: `상태=won` & 수강시작일 또는 수강종료일 결측.
- R4: `상태=won` & 코스 ID 결측(문자열 결측 포함).
- R5: `상태=won` & `성사_norm` ≠ 확정.
- R6: `상태=lost` & `성사_norm` ≠ LOST.
- R7: 계약 체결일 > 수강시작일 AND 계약/시작 연월이 다름. 예외(`R7_EXEMPT`)는 집계/표시에서 제거:
  - 담당자=강진우 & 기업명∈{홈앤서비스, 엔씨소프트, 엘지전자}
  - 과정포맷 ∈ {구독제(온라인), 선택구매(온라인)}
- R8: 생성 후 7일 경과 & 카테고리 결측.
- R9: 생성 후 7일 경과 & 과정포맷 결측.
- R10: `성사=높음` & 수주 예정일 결측.
- R11: `상태=convert`.
- R12: `성사=높음/확정` & 금액·예상 체결액 모두 결측.
- R13: `상태=won` & 고객사 담당자 메타 4개 중 하나라도 결측(소속 상위 조직, 팀(명함/메일서명), 직급(명함/메일서명), 고객 담당 교육 영역).
  - 예외: 담당자 ∈ {김정은, 이은서} AND 딜 이름에 `1~12월` 문자열 포함 시 R13/R15에서 제외.
- R14: `상태=won` & 과정포맷 ∈ {구독제(온라인), 선택구매(온라인)} & 온라인 입과 정보(`(온라인)입과 주기`, `(온라인)최초 입과 여부`) 중 하나라도 결측.
- R15: `상태=won` & 과정포맷 ∈ {출강, 복합(출강+온라인), 비대면 실시간} & 강사 정보(강사 이름1 OR 강사료1) 결측.
  - 동일한 담당자/월 키워드 예외는 R13과 공유.

## UI & filtering behavior
- Sidebar filters: 팀(전체/3팀) → 담당자(전체/해당 팀 구성원). 필터 후 `apply_deal_exclusions` 적용.
- 팀 전체 화면:
  - `담당자_name` 기준 피벗: 각 R1~R15 True 수를 합산, `총이슈`(행 합)로 정렬.
  - R7는 `R7_EXEMPT` 제거 후 카운트.
- 개인 화면:
  - R-code별 건수를 세어 상위 6개를 metric으로 표시.
  - 코드별 expander에 해당 딜 목록 표시(없으면 스킵). R7 역시 예외 제거 후 사용.
  - 규칙 위배가 없으면 success 메시지.

## Display builder (`to_display`)
- 날짜 컬럼(수주 예정일/계약 체결일/수강시작/수강종료)을 date로 표시.
- 행 단위로 True인 규칙 코드만 모아 `이슈코드`(쉼표), `이슈설명`(라벨 포함 세미콜론), `이슈수`(True 합) 생성.
- 기본 표시 컬럼 순서: 생성 날짜, 기업명, 이름, 팀_0_name, 담당자_name, 상태, 성사 가능성, 수주 예정일, 계약 체결일, 예상 체결액, 금액, 수강시작일, 수강종료일, 코스 ID, 카테고리, 과정포맷 + 이슈코드/설명/수.
- 개인 화면에서 R13/14/15일 때만 과정포맷 뒤에 추가 필드를 삽입:
  - R13: 기업명, 고객사 담당자명, 소속 상위 조직, 팀(명함/메일서명), 직급(명함/메일서명), 고객 담당 교육 영역
  - R14: (온라인)입과 주기, (온라인)최초 입과 여부
  - R15: 강사 이름1, 강사료1
- 정렬: 이슈수 내림차순 → 생성 날짜 내림차순.

## Operational notes / pitfalls
- 금액 0은 허용이므로 NaN 여부만 검사(R2). 예상 체결액 단독 결측은 카운트 안 함.
- R7은 동년월이면 허용(월 단위로 계약/시작이 같으면 OK), 예외 포맷/담당자·기업을 제거 후 집계.
- 연락처/온라인입과/강사 필드는 소스에 없을 때 NA로 생성되므로, 실제 데이터에 새 필드가 들어오면 ensure_column 없이도 그대로 사용됨.
- 팀/담당자 맵이 바뀌면 필터 옵션과 대상 데이터가 달라짐 → TEAM_RAW/NAME2TEAM 업데이트 필요.
- 새 규칙 추가 시: RULE_LABELS/RULE_CODES 추가 → 플래그 계산 → to_display/피벗/metric에 자동 반영되므로 컬럼 이름 충돌 주의.
